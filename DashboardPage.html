<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Sistema de Estoque</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #334155;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .nav {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px var(--shadow);
      border: 1px solid var(--border);
    }

    .nav h1 {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-links {
      display: flex;
      gap: 1rem;
    }

    .nav-link {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 500;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .nav-link:hover {
      color: var(--text);
      background: rgba(99, 102, 241, 0.1);
      border-color: var(--primary);
    }

    .nav-link.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 12px var(--shadow);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .card-header h2 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .card-body {
      min-height: 200px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .metric-card {
      background: linear-gradient(135deg, var(--bg-card) 0%, #2d3748 100%);
      border-radius: 16px;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 4px 6px var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px var(--shadow);
    }

    .metric-icon {
      font-size: 3rem;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    }

    .metric-content {
      flex: 1;
    }

    .metric-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .metric-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.25rem;
    }

    .metric-subtitle {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .btn-secondary {
      padding: 0.875rem 2rem;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--primary);
    }

    .period-selector {
      display: flex;
      gap: 0.5rem;
    }

    .period-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
    }

    .period-btn:hover {
      border-color: var(--primary);
      color: var(--text);
    }

    .period-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .sales-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .sale-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--bg);
      border-radius: 8px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .sale-item:hover {
      border-color: var(--primary);
      transform: translateX(4px);
    }

    .sale-info {
      flex: 1;
    }

    .sale-product {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }

    .sale-details {
      display: flex;
      gap: 1rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .sale-sku {
      font-family: monospace;
    }

    .sale-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--success);
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
      font-size: 1.125rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      border-radius: 8px;
      padding: 1rem;
      color: var(--danger);
      text-align: center;
    }

    #earningsChart {
      height: 300px !important;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .nav {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .nav-links {
        flex-direction: column;
        width: 100%;
      }

      .nav-link {
        width: 100%;
        text-align: center;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .card-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .period-selector {
        width: 100%;
        justify-content: stretch;
      }

      .period-btn {
        flex: 1;
      }

      .sale-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card,
    .metric-card {
      animation: fadeIn 0.5s ease;
    }
  </style>
</head>

<body>
  <div class="container">
    <nav class="nav">
      <h1>üìä Sistema de Controle de Estoque</h1>
      <div class="nav-links">
        <a href="<?!= getScriptUrl() ?>?page=dashboard" class="nav-link active">Dashboard</a>
        <a href="<?!= getScriptUrl() ?>?page=products" class="nav-link">Produtos</a>
        <a href="<?!= getScriptUrl() ?>?page=sales" class="nav-link">Vendas</a>
      </div>
    </nav>

    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-icon">üí∞</div>
        <div class="metric-content">
          <div class="metric-label">Ganhos Hoje</div>
          <div class="metric-value" id="dailyEarnings">R$ 0,00</div>
          <div class="metric-subtitle" id="dailySales">0 vendas</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">üì¶</div>
        <div class="metric-content">
          <div class="metric-label">Itens Vendidos</div>
          <div class="metric-value" id="itemsSold">0</div>
          <div class="metric-subtitle">hoje</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">üìà</div>
        <div class="metric-content">
          <div class="metric-label">M√©dia Di√°ria (7d)</div>
          <div class="metric-value" id="averageEarnings">R$ 0,00</div>
          <div class="metric-subtitle" id="weeklyTotal">R$ 0,00 total</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">üõçÔ∏è</div>
        <div class="metric-content">
          <div class="metric-label">Total (30d)</div>
          <div class="metric-value" id="monthlyEarnings">R$ 0,00</div>
          <div class="metric-subtitle" id="monthlySales">0 vendas</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>üìä Ganhos por Per√≠odo</h2>
        <div class="period-selector">
          <button class="period-btn active" data-days="7">7 dias</button>
          <button class="period-btn" data-days="14">14 dias</button>
          <button class="period-btn" data-days="30">30 dias</button>
        </div>
      </div>
      <div class="card-body">
        <canvas id="earningsChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>üõí √öltimas Vendas</h2>
        <button class="btn-secondary" onclick="loadRecentSales()">üîÑ Atualizar</button>
      </div>
      <div class="card-body">
        <div id="recentSalesContainer">
          <div class="loading">Carregando vendas...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    let earningsChart = null;
    let currentPeriod = 7;
    window.onload = function () {
      loadDashboardData();
      loadRecentSales();
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentPeriod = parseInt(this.dataset.days);
          loadEarningsChart(currentPeriod);
        });
      });
    };
    function loadDashboardData() {
      callAPI('getDailyEarnings', {}, function (result) {
        if (result.success) {
          document.getElementById('dailyEarnings').textContent = formatCurrency(result.earnings);
          document.getElementById('dailySales').textContent = result.salesCount + ' vendas';
          document.getElementById('itemsSold').textContent = result.itemsSold;
        }
      });
      callAPI('getWeeklyEarnings', {}, function (result) {
        if (result.success && result.summary) {
          const avg = result.summary.averagePerDay || 0;
          document.getElementById('averageEarnings').textContent = formatCurrency(avg);
          document.getElementById('weeklyTotal').textContent = formatCurrency(result.summary.totalEarnings) + ' total';
        }
      });
      callAPI('getMonthlyEarnings', {}, function (result) {
        if (result.success && result.summary) {
          document.getElementById('monthlyEarnings').textContent = formatCurrency(result.summary.totalEarnings);
          document.getElementById('monthlySales').textContent = result.summary.totalSales + ' vendas';
        }
      });
      loadEarningsChart(currentPeriod);
    }
    function loadEarningsChart(days) {
      callAPI('getEarningsByDays', { days: days }, function (result) {
        if (result.success) {
          const labels = [];
          const data = [];
          result.dailyEarnings.forEach(day => {
            const date = new Date(day.date);
            labels.push(date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
            data.push(day.earnings);
          });
          const ctx = document.getElementById('earningsChart').getContext('2d');
          if (earningsChart) earningsChart.destroy();
          earningsChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Ganhos (R$)',
                data: data,
                borderColor: 'rgb(99, 102, 241)',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgb(99, 102, 241)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  padding: 12,
                  titleColor: '#fff',
                  bodyColor: '#fff',
                  borderColor: 'rgb(99, 102, 241)',
                  borderWidth: 1,
                  callbacks: {
                    label: function (context) {
                      return 'R$ ' + context.parsed.y.toFixed(2).replace('.', ',');
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { callback: function (value) { return 'R$ ' + value.toFixed(0); } },
                  grid: { color: 'rgba(0, 0, 0, 0.05)' }
                },
                x: { grid: { display: false } }
              }
            }
          });
        }
      });
    }
    function loadRecentSales() {
      const container = document.getElementById('recentSalesContainer');
      container.innerHTML = '<div class="loading">Carregando vendas...</div>';
      callAPI('getRecentSales', { limit: 15 }, function (result) {
        if (result.success) {
          if (result.sales.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhuma venda registrada ainda</div>';
            return;
          }
          let html = '<div class="sales-list">';
          result.sales.forEach(sale => {
            html += `<div class="sale-item"><div class="sale-info"><div class="sale-product">${sale.product}</div><div class="sale-details"><span class="sale-sku">${sale.sku}</span><span class="sale-qty">${sale.quantity}x</span><span class="sale-date">${sale.date}</span></div></div><div class="sale-value">${formatCurrency(sale.totalValue)}</div></div>`;
          });
          html += '</div>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="error">Erro ao carregar vendas</div>';
        }
      });
    }
    function formatCurrency(value) {
      return 'R$ ' + parseFloat(value).toFixed(2).replace('.', ',');
    }
    function callAPI(action, data, callback) {
      const url = '<?= getScriptUrl() ?>';
      fetch(url, {
        method: 'POST',
        body: JSON.stringify({ action: action, ...data })
      })
        .then(response => response.json())
        .then(callback)
        .catch(error => {
          console.error('Erro na API:', error);
          if (callback) callback({ success: false, message: error.message });
        });
    }
  </script>
</body>

</html>